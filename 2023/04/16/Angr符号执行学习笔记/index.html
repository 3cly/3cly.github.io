



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="tcK6frO9MMMjv-s9v_SHFiAvsW8YHyINmZlIiYn3a4g" />


<link rel="alternate" type="application/rss+xml" title="skyの博客" href="https://3cly.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="skyの博客" href="https://3cly.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="skyの博客" href="https://3cly.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="笔记" />


<link rel="canonical" href="https://3cly.github.io/2023/04/16/Angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">



  <title>
Angr符号执行学习笔记 - 学习 |
静かな港 = skyの博客 = 从来如此,便对么?</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Angr符号执行学习笔记
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2023-04-16 20:50:29">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2023-04-16T20:50:29+08:00">2023-04-16</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>22k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>20 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">静かな港</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://pic.imgdb.cn/item/640da918f144a010074b42d6.jpg"></li>
          <li class="item" data-background-image="https://pic.imgdb.cn/item/640da7eaf144a010074929bf.jpg"></li>
          <li class="item" data-background-image="https://pic.imgdb.cn/item/63bec151be43e0d30e4da569.jpg"></li>
          <li class="item" data-background-image="https://pic.imgdb.cn/item/63ddece54757feff33b8136e.jpg"></li>
          <li class="item" data-background-image="https://pic.imgdb.cn/item/63bec082be43e0d30e4bcdb9.png"></li>
          <li class="item" data-background-image="https://pic.imgdb.cn/item/640da27bf144a010073fc581.png"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="item" rel="index" title="分类于 学习"><span itemprop="name">学习</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://3cly.github.io/2023/04/16/Angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.png">
    <meta itemprop="name" content="sky">
    <meta itemprop="description" content="从来如此,便对么?, 一只菜狗的博客">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="skyの博客">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="angr学习"><a class="markdownIt-Anchor" href="#angr学习">#</a> Angr 学习</h1>
<p>学习 angr 借鉴了 Syclover 战队大佬 SYJ 的笔记 https://agate-colony-3f5.notion.site/angr_ctf-8a26aa74a4a74c428ef6129e2df6dd02</p>
<h2 id="angr"><a class="markdownIt-Anchor" href="#angr">#</a> Angr</h2>
<p>angr 是一个二进制分析框架，它可以用于静态和动态分析，以及漏洞发现等方面。它被设计用来处理二进制文件，包括 ELF，PE 和 Mach-O 等文件格式。</p>
<p>angr 提供了一个 Python API，可以用来编写脚本来自动化分析过程。它支持多种分析技术，包括符号执行，动态符号执行和模糊测试等。它还提供了一些有用的工具，如符号执行器、符号内存和符号寄存器等，以帮助用户进行深入的分析。</p>
<p>angr 的一个优点是它可以在不需要人工干预的情况下进行自动化分析。这使其成为安全研究人员和漏洞猎人的有用工具，他们可以使用 angr 来自动发现漏洞并生成利用代码。</p>
<h3 id="使用-angr-的大概步骤"><a class="markdownIt-Anchor" href="#使用-angr-的大概步骤">#</a> 使用 angr 的大概步骤</h3>
<ul>
<li>创建 project</li>
<li>设置 state</li>
<li>新建 符号量 : BVS (bitvector symbolic) 或 BVV (bitvector value) [约束求解时的自变量，可类比 z3]</li>
<li>把符号量设置到内存或者其他地方 (这两步非必须)</li>
<li>设置 Simulation Managers ， 进行路径探索的对象</li>
<li>运行，探索满足路径需要的值</li>
<li>约束求解，获取执行结果</li>
</ul>
<h3 id="00_angr_find"><a class="markdownIt-Anchor" href="#00_angr_find">#</a> 00_angr_find</h3>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 加载可执行文件路径</span></pre></td></tr><tr><td data-num="5"></td><td><pre>path_to_binary <span class="token operator">=</span> <span class="token string">"./00_angr_find"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 找到入口</span></pre></td></tr><tr><td data-num="9"></td><td><pre>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 创建模拟管理器，支持搜索和执行</span></pre></td></tr><tr><td data-num="12"></td><td><pre>simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 设置要进入的位置:integer (probably in hexadecimal)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span><span class="token number">0x08048678</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># 查看结果状态</span></pre></td></tr><tr><td data-num="18"></td><td><pre>solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 输出结果</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><img data-src="/images/image-20230407212823955.png" alt="image-20230407212823955"></p>
<p><img data-src="/images/image-20230407212849218.png" alt="image-20230407212849218"></p>
<h3 id="01_angr_avoid"><a class="markdownIt-Anchor" href="#01_angr_avoid">#</a> 01_angr_avoid</h3>
<p>使用.explore () 方法的另一个参数 avoid 来回避 avoid_me 函数即可 (如果 IDA 按 TAB 会提示 main 函数过大)<img data-src="/images/image-20230410164448520.png" alt="image-20230410164448520"></p>
<p>直接找到 2 个函数的地址就能写脚本了</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 加载可执行文件路径</span></pre></td></tr><tr><td data-num="5"></td><td><pre>path_to_binary <span class="token operator">=</span> <span class="token string">"./01_angr_avoid"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 找到入口</span></pre></td></tr><tr><td data-num="9"></td><td><pre>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 创建模拟管理器，支持搜索和执行</span></pre></td></tr><tr><td data-num="12"></td><td><pre>simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 设置要进入的位置，回避的函数</span></pre></td></tr><tr><td data-num="15"></td><td><pre>simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span><span class="token number">0x80485f7</span><span class="token punctuation">,</span>avoid<span class="token operator">=</span><span class="token number">0x80485bf</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># 查看结果状态</span></pre></td></tr><tr><td data-num="18"></td><td><pre>solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 输出结果</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>结果:</strong></p>
<pre><code>root@mou-virtual-machine:/home/mou/桌面/angr_ctf-master/solutions/01_angr_avoid#
 python3 try.py
WARNING  | 2023-04-10 16:51:27,641 | angr.storage.memory_mixins.default_filler_mixin | The program is accessing register with an unspecified value. This could indicate unwanted behavior.
WARNING  | 2023-04-10 16:51:27,641 | angr.storage.memory_mixins.default_filler_mixin | angr will cope with this by generating an unconstrained symbolic variable and continuing. You can resolve this by:
WARNING  | 2023-04-10 16:51:27,642 | angr.storage.memory_mixins.default_filler_mixin | 1) setting a value to the initial state
WARNING  | 2023-04-10 16:51:27,642 | angr.storage.memory_mixins.default_filler_mixin | 2) adding the state option ZERO_FILL_UNCONSTRAINED_&#123;MEMORY,REGISTERS&#125;, to make unknown regions hold null
WARNING  | 2023-04-10 16:51:27,642 | angr.storage.memory_mixins.default_filler_mixin | 3) adding the state option SYMBOL_FILL_UNCONSTRAINED_&#123;MEMORY,REGISTERS&#125;, to suppress these messages.
WARNING  | 2023-04-10 16:51:27,642 | angr.storage.memory_mixins.default_filler_mixin | Filling register edi with 4 unconstrained bytes referenced from 0x80d45b1 (__libc_csu_init+0x1 in 01_angr_avoid (0x80d45b1))
WARNING  | 2023-04-10 16:51:31,839 | angr.storage.memory_mixins.default_filler_mixin | Filling memory at 0x7ffeff3d with 11 unconstrained bytes referenced from 0x819b3b0 (strncmp+0x0 in libc.so.6 (0x9b3b0))
WARNING  | 2023-04-10 16:51:31,839 | angr.storage.memory_mixins.default_filler_mixin | Filling memory at 0x7ffeff60 with 4 unconstrained bytes referenced from 0x819b3b0 (strncmp+0x0 in libc.so.6 (0x9b3b0))
b'JLVUSGJZ'
root@mou-virtual-machine:/home/mou/桌面/angr_ctf-master/solutions/01_angr_avoid#
 ./01_angr_avoid
Enter the password: JLVUSGJZ
Good Job.
</code></pre>
<h3 id="02_angr_find_condition"><a class="markdownIt-Anchor" href="#02_angr_find_condition">#</a> 02_angr_find_condition</h3>
<p>学习根据程序本身的输出来告诉 angr 应避免或保留的内容，而不是每次都找打印错误提示的函数地址</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">def</span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    path_to_binary <span class="token operator">=</span> <span class="token string">"./02_angr_find_condition"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#输出内容放到变量中</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">if</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">if</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span>  stdout_output<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Solution is: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>solution<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    Go<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>注意，这不是字符串，而是字节对象，这意味着我们必须使用 b’Good Job.' 而不是仅 &quot;Good Job.&quot; 来检查我们是否正确输出了 “Good Job.”</p>
<h3 id="03_angr_simbolic_registers"><a class="markdownIt-Anchor" href="#03_angr_simbolic_registers">#</a> 03_angr_simbolic_registers</h3>
<p>学会符号化寄存器</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token string">b'Good Job.\n'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token string">b'Try again.\n'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">def</span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    path_to_binary <span class="token operator">=</span> <span class="token string">"./03_angr_symbolic_registers"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    start_address <span class="token operator">=</span> <span class="token number">0x80488c7</span> </pre></td></tr><tr><td data-num="25"></td><td><pre>    initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>start_address<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    passwd_size_in_bits <span class="token operator">=</span> <span class="token number">32</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    passwd0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'passwd0'</span><span class="token punctuation">,</span> passwd_size_in_bits<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    passwd1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'passwd1'</span><span class="token punctuation">,</span> passwd_size_in_bits<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    passwd2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'passwd2'</span><span class="token punctuation">,</span> passwd_size_in_bits<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> passwd0</pre></td></tr><tr><td data-num="33"></td><td><pre>    initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>ebx <span class="token operator">=</span> passwd1</pre></td></tr><tr><td data-num="34"></td><td><pre>    initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>edx <span class="token operator">=</span> passwd2</pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">for</span> i <span class="token keyword">in</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            solution_state <span class="token operator">=</span> i</pre></td></tr><tr><td data-num="43"></td><td><pre>            solution0 <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>passwd0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            solution1 <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>passwd1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            solution2 <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>passwd2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            solution <span class="token operator">=</span> solution0 <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> solution1 <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> solution2</pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Success! Solution is: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token comment"># print(simgr.found[0].posix.dumps(0))</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    Go<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>这里用到了 claripy 模块，claripy 主要将变量符号化，生成约束式并求解约束式，这也是符号执行的核心所在，在 angr 中主要是利用微软提供的 z3 库去解约束式。</p>
<h3 id="04_angr_symbolic_stack"><a class="markdownIt-Anchor" href="#04_angr_symbolic_stack">#</a> 04_angr_symbolic_stack</h3>
<p>学习符号化栈区 (从之前的寄存器传参变成了利用栈空间传参)</p>
<p><img data-src="/images/image-20230411205729603.png" alt="image-20230411205729603"></p>
<p>手动布置栈</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>filename <span class="token operator">=</span> <span class="token string">"04_angr_symbolic_stack"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>p <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>filename<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>startAddr <span class="token operator">=</span> <span class="token number">0x080486AE</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>init_state <span class="token operator">=</span> p<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>startAddr<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>init_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>init_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>ebp<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>init_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>ebp <span class="token operator">=</span> init_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>esp</pre></td></tr><tr><td data-num="12"></td><td><pre>init_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>esp <span class="token operator">-=</span> <span class="token number">8</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>pass1 <span class="token operator">=</span> init_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'pass1'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>pass2 <span class="token operator">=</span> init_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'pass2'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>init_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>pass1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>init_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>pass2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>sm <span class="token operator">=</span> p<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>init_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">def</span> <span class="token function">is_good</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">b'Good Job'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">def</span> <span class="token function">is_bad</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">b'Try again'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>sm<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_good<span class="token punctuation">,</span> avoid<span class="token operator">=</span>is_bad<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">if</span> sm<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    found_state <span class="token operator">=</span> sm<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    passwodr1 <span class="token operator">=</span> found_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>pass1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    passwodr2 <span class="token operator">=</span> found_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>pass2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Solution:"</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>passwodr1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>passwodr2<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"No solution found!"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="05_angr_symbolic_memory"><a class="markdownIt-Anchor" href="#05_angr_symbolic_memory">#</a> 05_angr_symbolic_memory</h3>
<p>学习符号化内存 (符号化.bss 段)</p>
<p>4 个输入字符串存于内存地址</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token string">b'Good Job.\n'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token string">b'Try again.\n'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">def</span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    path_to_binary <span class="token operator">=</span> <span class="token string">"./05_angr_symbolic_memory"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    start_address <span class="token operator">=</span> <span class="token number">0x08048618</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>start_address<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    passwd_size_in_bits <span class="token operator">=</span> <span class="token number">64</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    passwd0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'passwd0'</span><span class="token punctuation">,</span> passwd_size_in_bits<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    passwd1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'passwd1'</span><span class="token punctuation">,</span> passwd_size_in_bits<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    passwd2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'passwd2'</span><span class="token punctuation">,</span> passwd_size_in_bits<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    passwd3 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'passwd3'</span><span class="token punctuation">,</span> passwd_size_in_bits<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    passwd0_address <span class="token operator">=</span> <span class="token number">0x0AB232C0</span> <span class="token comment"># user_input addr</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>passwd0_address<span class="token punctuation">,</span> passwd0<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>passwd0_address <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">,</span> passwd1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>passwd0_address <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">,</span> passwd2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>passwd0_address <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">,</span> passwd3<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">for</span> i <span class="token keyword">in</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            solution_state <span class="token operator">=</span> i</pre></td></tr><tr><td data-num="49"></td><td><pre>            solution0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>passwd0<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            solution1 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>passwd1<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            solution2 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>passwd2<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            solution3 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>passwd3<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            solution <span class="token operator">=</span> solution0 <span class="token operator">+</span> <span class="token string">b" "</span> <span class="token operator">+</span> solution1 <span class="token operator">+</span> <span class="token string">b" "</span> <span class="token operator">+</span> solution2 <span class="token operator">+</span> <span class="token string">b" "</span> <span class="token operator">+</span> solution3</pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Success! Solution is: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>solution<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token comment"># print(solution0, solution1, solution2, solution3)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    Go<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>[+] Success! Solution is: OJQVXIVX LLEAOODW UVCWUVVC AJXJMVKA</p>
<h3 id="06_angr_symbolic_dynamic_memory"><a class="markdownIt-Anchor" href="#06_angr_symbolic_dynamic_memory">#</a> 06_angr_symbolic_dynamic_memory</h3>
<p>这题主要是学会符号化动态内存，这个题与上题没有太大区别，除了字符串的内存是通过堆 malloc () 而不是堆栈分配的</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  path_to_binary <span class="token operator">=</span> <span class="token string">"./06_angr_symbolic_dynamic_memory"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  start_address <span class="token operator">=</span> <span class="token number">0x80486af</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">&#123;</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  password0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  password1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  fake_heap_address0 <span class="token operator">=</span> <span class="token number">0x4444444</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  pointer_to_malloc_memory_address0 <span class="token operator">=</span> <span class="token number">0xa2def74</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>pointer_to_malloc_memory_address0<span class="token punctuation">,</span> fake_heap_address0<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  fake_heap_address1 <span class="token operator">=</span> <span class="token number">0x4444454</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  pointer_to_malloc_memory_address1 <span class="token operator">=</span> <span class="token number">0xa2def7c</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>pointer_to_malloc_memory_address1<span class="token punctuation">,</span> fake_heap_address1<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>fake_heap_address0<span class="token punctuation">,</span> password0<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>fake_heap_address1<span class="token punctuation">,</span> password1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    solution0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password0<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    solution1 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password1<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    solution <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span> solution0<span class="token punctuation">,</span> solution1 <span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></td></tr></table></figure><p>实际上，(IDA 中) 可以看到在两次调用之后，根据 mov ds:buffer0, eax 和 mov ds:buffer1, eax 得知开辟后的缓冲区被复制到标识为 buffer0 和 buffer1 的两个存储区中</p>
<p>(这里总的逻辑是这样的，之前是 buffer 指向的是 malloc 分配好的内存地址，string 存在这里。现在是 buffer 指向的是我们伪造的地址，符号位向量存在这里)</p>
<p>将两个符号变量存储到一个预先分配的 fake_heap_address0 和 fake_heap_address1 地址中，这些地址是未使用的堆内存地址，Angr 使用 initial_state.memory.store 函数将符号变量存储到指定地址中。通过修改指向 malloc 分配的内存地址的指针，指向 fake_heap_address0 和 fake_heap_address1，从而欺骗程序，使其认为输入的密码已经存储在 malloc 分配的内存中。</p>
<h3 id="07_angr_symbolic_file"><a class="markdownIt-Anchor" href="#07_angr_symbolic_file">#</a> 07_angr_symbolic_file</h3>
<p>学习如何符号化一个文件里面的内容</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 1. 确定 fread 读取的文件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 2. 使用 Angr 模拟一个文件系统，让读取的文件被我们自己的文件替换</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 3. 使用符号值初始化文件，该值将使用 fread 读取</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 4. 求解符号输入以确定密码</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  path_to_binary <span class="token operator">=</span> <span class="token string">"./07_angr_symbolic_file"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  start_address <span class="token operator">=</span> <span class="token number">0x80488bc</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">&#123;</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  filename <span class="token operator">=</span> <span class="token string">'FOQVSBZB.txt'</span>  <span class="token comment"># :string</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  symbolic_file_size_bytes <span class="token operator">=</span> <span class="token number">8</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  password <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> symbolic_file_size_bytes <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  password_file <span class="token operator">=</span> angr<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>SimFile<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> content<span class="token operator">=</span>password<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  </pre></td></tr><tr><td data-num="28"></td><td><pre>  initial_state<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> password_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></td></tr></table></figure><p>简单来说利用 SimFile 形成符号化的文件的格式：</p>
<pre><code>simgr_file = angr.storage.SimFile(filename, content=xxxxxx, size=file_size)
</code></pre>
<p>该代码使用了 Angr 工具模拟了一个文件系统，以解决密码验证的问题。主要流程如下：</p>
<ol>
<li>使用 Angr 加载二进制文件，并指定程序入口地址。</li>
<li>使用 initial_state.fs.insert 函数向模拟文件系统中添加一个名为’FOQVSBZB.txt’的文件，并使用 claripy.BVS 定义了一个名为 password 的符号变量，表示密码。</li>
<li>将符号变量 password 存储到模拟文件系统的’FOQVSBZB.txt’文件中，作为文件的内容。</li>
<li>使用 Angr 的 simgr 对象，对初始状态进行符号执行，通过指定的 find 和 avoid 条件，找到满足条件的状态。</li>
<li>如果找到满足条件的状态，则从该状态中提取出 password 的解，输出解。</li>
<li>如果无法找到满足条件的状态，则抛出异常。</li>
</ol>
<p>该代码的核心思想是通过符号执行，对程序进行模拟，并在模拟的文件系统中添加一个文件，并将符号变量存储到该文件中。因此，当程序调用 fread 函数从文件中读取密码时，实际上读取的是符号变量，Angr 可以通过符号执行来解决密码验证的问题。</p>
<h3 id="08_angr_constraints"><a class="markdownIt-Anchor" href="#08_angr_constraints">#</a> 08_angr_constraints</h3>
<p>学习通过添加约束条件来解决路径爆炸问题</p>
<h4 id="路径爆炸"><a class="markdownIt-Anchor" href="#路径爆炸">#</a> 路径爆炸</h4>
<p>通过我们之前的学习体验感觉到 angr 这么强大的应用怎么没有在实际的测试生产中大规模应用，这是因为给符号执行技术在复杂程序的测试案例生成的应用中造成阻碍的两个大问题：一个是约束求解问题，另一个就是路径爆炸问题 (for 中 if)</p>
<p>所谓符号执行就是把程序中的变量符号化去模拟程序运行，搜集路径约束条件并使用约束求解器对其进行求解后得到结果。</p>
<p>当一个程序存在循环结构时，即使逻辑十分简单也可能会产生规模十分巨大的执行路径。在符号执行的过程中，每个分支点都会产生两个实例，当程序中存在循环结构展开时，可能会导致程序分支路径数呈指数级增长，即路径爆炸问题。故我们需要提供更多的约束条件控制路径爆炸问题。</p>
<h4 id="约束求解"><a class="markdownIt-Anchor" href="#约束求解">#</a> 约束求解</h4>
<p>在 angr 中提供了可以用加入一个约束条件到一个 state 中的方法（state.solver.add），将每一个符号化的布尔值作为一个关于符号变量合法性的断言。之后可以通过使用 state.solver.eval (symbol) 对各个断言进行评测来求出一个合法的符号值（若有多个合法值，返回其中的一个）。简单来说就是通过 .add 对 state 对象添加约束，并使用 .eval 接口求解，得到符号变量的可行解</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  path_to_binary <span class="token operator">=</span> <span class="token string">"./08_angr_constraints"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  start_address <span class="token operator">=</span> <span class="token number">0x804863c</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">&#123;</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  password <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">16</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  password_address <span class="token operator">=</span> <span class="token number">0x804a040</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password_address<span class="token punctuation">,</span> password<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment"># Angr will not be able to reach the point at which the binary prints out</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment"># 'Good Job.'. We cannot use that as the target anymore.</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment"># (!)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  address_to_check_constraint <span class="token operator">=</span> <span class="token number">0x8048683</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>address_to_check_constraint<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    constrained_parameter_address <span class="token operator">=</span> <span class="token number">0x804a040</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    constrained_parameter_size_bytes <span class="token operator">=</span> <span class="token number">16</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    constrained_parameter_bitvector <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      constrained_parameter_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      constrained_parameter_size_bytes</pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment"># We want to constrain the system to find an input that will make</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment"># constrained_parameter_bitvector equal the desired value.</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment"># (!)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    constrained_parameter_desired_value <span class="token operator">=</span> <span class="token string">'OSIWHBXIFOQVSBZB'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># :string (encoded)</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>  </pre></td></tr><tr><td data-num="44"></td><td><pre>    solution_state<span class="token punctuation">.</span>add_constraints<span class="token punctuation">(</span>constrained_parameter_bitvector <span class="token operator">==</span> constrained_parameter_desired_value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></td></tr></table></figure><p>该脚本使用 Angr 工具自动化解决二进制文件中的密码问题。它首先加载二进制文件，然后使用  <code>angr.Project()</code>  创建一个项目对象。接下来，它使用初始状态创建一个符号变量  <code>password</code> ，并将其存储在地址  <code>0x804a040</code>  中。然后，它使用  <code>project.factory.simgr()</code>  创建一个模拟器对象，该对象用于探索状态空间以找到目标状态。接着，它探索状态空间以找到特定地址  <code>0x8048683</code> ，该地址检查密码是否正确。<strong>如果找到目标状态，则添加约束条件，使  <code>constrained_parameter_bitvector</code>  等于预期值。最后，它使用  <code>solver.eval()</code>  求解约束条件</strong>，并打印出解决方案。如果找不到解决方案，则会引发异常。</p>
<h3 id="09_angr_hooks"><a class="markdownIt-Anchor" href="#09_angr_hooks">#</a> 09_angr_hooks</h3>
<p><s>之前三面学过 inline hook 但还没咋应用过</s></p>
<p>学习使用 angr 的 hook 技术解决路径爆炸问题，与刚刚利用的约束条件不同，hook 技术则更为强大！</p>
<h4 id="hook"><a class="markdownIt-Anchor" href="#hook">#</a> Hook</h4>
<p>angr 提供了简便的 Hook 接口，能够用于 Hook 被 angr 模拟执行的程序，它通常有两种方式：</p>
<ul>
<li>
<p>装饰器 @project.hook</p>
</li>
<li>
<p>函数 project.hook_symbol</p>
<p>装饰器:</p>
</li>
</ul>
<pre><code>@project.hook(0x80486B3, length=5)
</code></pre>
<p>第一个参数即需要 Hook 的调用函数的地址，第二个参数 length 即指定执行引擎在完成挂钩后应跳过多少字节。具体多少字节由 Hook 处地址的指令长度确定</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span>check_equals_called_address<span class="token punctuation">,</span> length<span class="token operator">=</span>instruction_to_skip_length<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">skip_check_equals_</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        user_input_buffer_address <span class="token operator">=</span> <span class="token number">0x804A054</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        user_input_buffer_length <span class="token operator">=</span> <span class="token number">16</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>        user_input_string <span class="token operator">=</span> state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            user_input_buffer_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            user_input_buffer_length</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>        check_against_string <span class="token operator">=</span> <span class="token string">'XKSPZSJKJYQCQXZV'</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>        register_size_bit <span class="token operator">=</span> <span class="token number">32</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            user_input_string <span class="token operator">==</span> check_against_string<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> register_size_bit<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> register_size_bit<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">)</span><span class="token comment">#不再循环了</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>脚本</strong></p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  path_to_binary <span class="token operator">=</span> <span class="token string">"./09_angr_hooks"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment"># Since Angr can handle the initial call to scanf, we can start from the</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment"># beginning.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">&#123;</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment"># Hook the address of where check_equals_ is called.</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment"># (!)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  check_equals_called_address <span class="token operator">=</span> <span class="token number">0x80486ca</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment"># The length parameter in angr.Hook specifies how many bytes the execution</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment"># engine should skip after completing the hook. This will allow hooks to</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment"># replace certain instructions (or groups of instructions). Determine the</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment"># instructions involved in calling check_equals_, and then determine how many</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment"># bytes are used to represent them in memory. This will be the skip length.</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment"># (!)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  instruction_to_skip_length <span class="token operator">=</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span>check_equals_called_address<span class="token punctuation">,</span> length<span class="token operator">=</span>instruction_to_skip_length<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">def</span> <span class="token function">skip_check_equals_</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    user_input_buffer_address <span class="token operator">=</span> <span class="token number">0x804a044</span> </pre></td></tr><tr><td data-num="31"></td><td><pre>    user_input_buffer_length <span class="token operator">=</span> <span class="token number">16</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    user_input_string <span class="token operator">=</span> state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      user_input_buffer_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      user_input_buffer_length</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    </pre></td></tr><tr><td data-num="39"></td><td><pre>    check_against_string <span class="token operator">=</span> <span class="token string">'OSIWHBXIFOQVSBZB'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># :string</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      user_input_string <span class="token operator">==</span> check_against_string<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="43"></td><td><pre>      claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="44"></td><td><pre>      claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token comment"># Since we are allowing Angr to handle the input, retrieve it by printing</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment"># the contents of stdin. Use one of the early levels as a reference.</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></td></tr></table></figure><p>这段代码使用了 angr 工具包来通过符号执行解决程序的逆向分析问题。首先定义了程序路径 path_to_binary，然后使用 angr.Project 函数将其载入到 angr 中。接着使用 project.factory.entry_state 创建了一个初始状态 initial_state，该状态包含了程序的起始信息。然后，使用 project.hook 函数来注册了一个钩子函数，该钩子函数用于拦截到函数 check_equals_的调用，并修改其返回值。在钩子函数中，首先确定了用户输入的地址和长度，并使用 state.memory.load 方法从用户输入的地址中读取出用户输入的字符串。接着确定了需要与用户输入的字符串进行比较的字符串，并使用 claripy 库中的 If 方法来判断两者是否相等，从而修改 eax 寄存器中的值。最后，使用 project.factory.simgr 函数来创建了一个符号执行器 simulation，并使用其 explore 方法来探索符号执行的状态空间，直到找到满足 is_successful 条件的状态或避免 should_abort 条件的状态。如果找到了满足条件的状态，则从该状态中获取解决方案，并打印输出。否则，抛出异常并提示无法找到解决方案。</p>
<p><strong>另一个版本</strong> (其实差不多)</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">def</span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    path_to_binary <span class="token operator">=</span> <span class="token string">"./09_angr_hooks"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    check_equals_called_address <span class="token operator">=</span> <span class="token number">0x80486CA</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    instruction_to_skip_length <span class="token operator">=</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span>check_equals_called_address<span class="token punctuation">,</span> length<span class="token operator">=</span>instruction_to_skip_length<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">skip_check_equals_</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        user_input_buffer_address <span class="token operator">=</span> <span class="token number">0x804A044</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        user_input_buffer_length <span class="token operator">=</span> <span class="token number">16</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>        user_input_string <span class="token operator">=</span> state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            user_input_buffer_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            user_input_buffer_length</pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>        check_against_string <span class="token operator">=</span> <span class="token string">'OSIWHBXIFOQVSBZB'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>        register_size_bit <span class="token operator">=</span> <span class="token number">32</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            user_input_string <span class="token operator">==</span> check_against_string<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> register_size_bit<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> register_size_bit<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">if</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">if</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span>  stdout_output<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">for</span> i <span class="token keyword">in</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            solution_state <span class="token operator">=</span> i</pre></td></tr><tr><td data-num="52"></td><td><pre>            solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Success! Solution is: &#123;0&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>solution<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token comment">#print(solution0)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    Go<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="10_angr_simprocedures"><a class="markdownIt-Anchor" href="#10_angr_simprocedures">#</a> 10_angr_simprocedures</h3>
<p>学习如何利用函数名进行 hook，而不是复杂的利用函数的调用地址</p>
<p>第十题的路径爆炸仍然发生在 check_equals 函数当中，与上一题的区别在于，此时输入的字符串被保存在局部变量当中，我们无法提前得知它的地址，因此如果要 hook 掉 check 函数，则必须获取 check 函数的参数。</p>
<p>同时，我们可以发现 check_equals 被调用了很多次，以致于无法通过地址 Hook 每个调用位置。 这时我们必须使用 SimProcedure 编写我们自己的 check_equals 实现，然后通过函数名 Hook 所有对 check_equals 的调用</p>
<p>因此需要使用 hook_symbol 的方式来 hook 掉 check 函数</p>
<h4 id="hooking-symbols"><a class="markdownIt-Anchor" href="#hooking-symbols">#</a> Hooking Symbols</h4>
<p>每一个程序都有一个符号表，angr 可以确保从每个导入符号都可以解析出地址，可以使用 angr 提供的 <code>Project.hook_symbol</code> API 来通过符号名来 Hook 函数所有的调用地址，这意味着可以用自己的代码替换函数</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> time</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>time_strat <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">def</span> <span class="token function">good</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    tag <span class="token operator">=</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">True</span> <span class="token keyword">if</span> tag <span class="token keyword">else</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">def</span> <span class="token function">bad</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    tag <span class="token operator">=</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">True</span> <span class="token keyword">if</span> tag <span class="token keyword">else</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>path_to_binary <span class="token operator">=</span> <span class="token string">'./10_angr_simprocedures'</span></pre></td></tr><tr><td data-num="20"></td><td><pre>p <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>init_state <span class="token operator">=</span> p<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Hook</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment"># 后两个参数即为 check_equals 函数的参数</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        input_buffer <span class="token operator">=</span> addr</pre></td></tr><tr><td data-num="28"></td><td><pre>        input_size <span class="token operator">=</span> size</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment"># 从内存中读取输入</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        input_str <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> input_size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        right_str <span class="token operator">=</span> <span class="token string">'OSIWHBXIFOQVSBZB'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment"># 比较返回符号约束</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        result <span class="token operator">=</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span>input_str <span class="token operator">==</span> right_str<span class="token punctuation">,</span> claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                            claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">return</span> result</pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment"># funcname 一定要相同，可在 IDA 中查看</span></pre></td></tr><tr><td data-num="40"></td><td><pre>hooked_funcname <span class="token operator">=</span> <span class="token string">'check_equals_OSIWHBXIFOQVSBZB'</span></pre></td></tr><tr><td data-num="41"></td><td><pre>p<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span>hooked_funcname<span class="token punctuation">,</span> Hook<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>simgr <span class="token operator">=</span> p<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>init_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>good<span class="token punctuation">,</span> avoid<span class="token operator">=</span>bad<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    flag <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="11_angr_sim_scanf"><a class="markdownIt-Anchor" href="#11_angr_sim_scanf">#</a> 11_angr_sim_scanf</h3>
<p>如题，这题主要是学习如何 hook <code>scanf</code>  函数，步骤其实与上一题是几乎一致的，得先找到需要 hook 的函数符号，然后编写一个继承 angr.SimProcedure 的类，然后利用 <code>hook_symbol</code>  对函数进行 hook</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">def</span> <span class="token function">good</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    tag <span class="token operator">=</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">True</span> <span class="token keyword">if</span> tag <span class="token keyword">else</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">def</span> <span class="token function">bad</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    tag <span class="token operator">=</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">True</span> <span class="token keyword">if</span> tag <span class="token keyword">else</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>path_to_binary <span class="token operator">=</span> <span class="token string">'./11_angr_sim_scanf'</span></pre></td></tr><tr><td data-num="13"></td><td><pre>project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ReplacementScanf</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment"># 第一个参数是 scanf 的格式化字符串，接着是两个 buffer 地址</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> format_string<span class="token punctuation">,</span> scanf0_address<span class="token punctuation">,</span> scanf1_address<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment"># 在 run 中完成 scanf 的功能，即向目标地址写入符号</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment"># 定义两个符号变量，用于写入 buffer</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        scanf0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'scanf0'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        scanf1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'scanf1'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment"># 写入内存，最后一个参数指定字节序</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>scanf0_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                                scanf0<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                                endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>scanf1_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                                scanf1<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                                endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment"># 保存变量到全局，方便后续约束求解</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solution0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> scanf0</pre></td></tr><tr><td data-num="34"></td><td><pre>        self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solution1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> scanf1</pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment"># scanf 的函数名称，可在 ida 中查看</span></pre></td></tr><tr><td data-num="37"></td><td><pre>scanf_symbol <span class="token operator">=</span> <span class="token string">'__isoc99_scanf'</span></pre></td></tr><tr><td data-num="38"></td><td><pre>project<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span>scanf_symbol<span class="token punctuation">,</span> ReplacementScanf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>good<span class="token punctuation">,</span> avoid<span class="token operator">=</span>bad<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment"># 对符号变量进行约束求解</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    stored_solutions0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solution0'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    stored_solutions1 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solution1'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    scanf0_solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>stored_solutions0<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    scanf1_solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>stored_solutions1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>scanf0_solution<span class="token punctuation">,</span> scanf1_solution<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>run 方法用于执行 ReplacementScanf 类的实例。该方法接收三个参数，分别为 format_string、param0 和 param1。</p>
<h3 id="12_angr_veritesting"><a class="markdownIt-Anchor" href="#12_angr_veritesting">#</a> 12_angr_veritesting</h3>
<p>此题与之前的题目不同的地方在于，它不仅是按位进行比较的，而且是按位进行混淆后马上比较。之前的题目都是整体混淆后比较。因此路径爆炸同时出现在混淆和比较两个地方。</p>
<p>考虑使用路径归并的搜索策略 veritesting 解题 (体验一下 veritesting)</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> angr</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> claripy</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'12_angr_veritesting'</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	project<span class="token operator">=</span>angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	initial_state<span class="token operator">=</span>project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	</pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token comment">#Veritesting 结合了静态符合执行与动态符号执行，减少了路径爆炸的影响</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	simulation<span class="token operator">=</span>project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">,</span>veritesting<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">def</span> <span class="token function">succ</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token keyword">return</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token keyword">def</span> <span class="token function">fail</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token keyword">return</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>succ<span class="token punctuation">,</span>avoid<span class="token operator">=</span>fail<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		solution_state<span class="token operator">=</span>simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Solution is &#123;0&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>solution<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	test<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      <div class="tags">
          <a href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> 笔记</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2023-04-16 20:58:03" itemprop="dateModified" datetime="2023-04-16T20:58:03+08:00">2023-04-16</time>
  </span>
  <span id="2023/04/16/Angr符号执行学习笔记/" class="item leancloud_visitors" data-flag-title="Angr符号执行学习笔记" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>sky <i class="ic i-at"><em>@</em></i>skyの博客
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://3cly.github.io/2023/04/16/Angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Angr符号执行学习笔记">https://3cly.github.io/2023/04/16/Angr符号执行学习笔记/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/04/02/%E5%87%A0%E9%81%93RE%E9%A2%98/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;63bec051be43e0d30e4b8150.png" title="几道RE题">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> 学习</span>
  <h3>几道RE题</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/04/25/pixel-4a-root/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;640da89ef144a010074a6468.jpg" title="pixel 4a root">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> 学习</span>
  <h3>pixel 4a root</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#angr%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.</span> <span class="toc-text"> Angr 学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#angr"><span class="toc-number">1.1.</span> <span class="toc-text"> Angr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-angr-%E7%9A%84%E5%A4%A7%E6%A6%82%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 使用 angr 的大概步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#00_angr_find"><span class="toc-number">1.1.2.</span> <span class="toc-text"> 00_angr_find</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#01_angr_avoid"><span class="toc-number">1.1.3.</span> <span class="toc-text"> 01_angr_avoid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#02_angr_find_condition"><span class="toc-number">1.1.4.</span> <span class="toc-text"> 02_angr_find_condition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#03_angr_simbolic_registers"><span class="toc-number">1.1.5.</span> <span class="toc-text"> 03_angr_simbolic_registers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#04_angr_symbolic_stack"><span class="toc-number">1.1.6.</span> <span class="toc-text"> 04_angr_symbolic_stack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#05_angr_symbolic_memory"><span class="toc-number">1.1.7.</span> <span class="toc-text"> 05_angr_symbolic_memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#06_angr_symbolic_dynamic_memory"><span class="toc-number">1.1.8.</span> <span class="toc-text"> 06_angr_symbolic_dynamic_memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#07_angr_symbolic_file"><span class="toc-number">1.1.9.</span> <span class="toc-text"> 07_angr_symbolic_file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#08_angr_constraints"><span class="toc-number">1.1.10.</span> <span class="toc-text"> 08_angr_constraints</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E7%88%86%E7%82%B8"><span class="toc-number">1.1.10.1.</span> <span class="toc-text"> 路径爆炸</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E6%B1%82%E8%A7%A3"><span class="toc-number">1.1.10.2.</span> <span class="toc-text"> 约束求解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#09_angr_hooks"><span class="toc-number">1.1.11.</span> <span class="toc-text"> 09_angr_hooks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hook"><span class="toc-number">1.1.11.1.</span> <span class="toc-text"> Hook</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10_angr_simprocedures"><span class="toc-number">1.1.12.</span> <span class="toc-text"> 10_angr_simprocedures</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hooking-symbols"><span class="toc-number">1.1.12.1.</span> <span class="toc-text"> Hooking Symbols</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11_angr_sim_scanf"><span class="toc-number">1.1.13.</span> <span class="toc-text"> 11_angr_sim_scanf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12_angr_veritesting"><span class="toc-number">1.1.14.</span> <span class="toc-text"> 12_angr_veritesting</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/2023/01/07/CSAPP%E3%81%AE%E5%AD%A6%E7%BF%92%E8%A8%98%E9%8C%B2/" rel="bookmark" title="CSAPPの学習記録">CSAPPの学習記録</a></li><li><a href="/2023/02/04/N1CTF%20Junior%20%20WP%20%20by%203cly/" rel="bookmark" title="N1CTF Junior  WP">N1CTF Junior  WP</a></li><li><a href="/2023/02/04/hgame2023%20%E9%83%A8%E5%88%86%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/" rel="bookmark" title="hgame2023 部分做题记录">hgame2023 部分做题记录</a></li><li><a href="/2023/02/26/shellcode&&vm/" rel="bookmark" title="shellcode&&vm">shellcode&&vm</a></li><li><a href="/2023/02/26/VNCTF/" rel="bookmark" title="VNCTF">VNCTF</a></li><li><a href="/2023/03/19/JAVA%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="JAVA学习">JAVA学习</a></li><li><a href="/2023/03/19/Write-Virtual-Machine/" rel="bookmark" title="Write Virtual Machine">Write Virtual Machine</a></li><li><a href="/2023/03/26/CMake/" rel="bookmark" title="=CMake=">=CMake=</a></li><li><a href="/2023/04/02/%E5%87%A0%E9%81%93RE%E9%A2%98/" rel="bookmark" title="几道RE题">几道RE题</a></li><li class="active"><a href="/2023/04/16/Angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="bookmark" title="Angr符号执行学习笔记">Angr符号执行学习笔记</a></li><li><a href="/2023/04/25/pixel-4a-root/" rel="bookmark" title="pixel 4a root">pixel 4a root</a></li><li><a href="/2023/05/28/%E5%88%9D%E8%AF%86Frida/" rel="bookmark" title="初识Frida">初识Frida</a></li><li><a href="/2023/05/28/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E4%B8%8E%E7%A0%94%E7%A9%B6%E8%BF%9B%E5%B1%95/" rel="bookmark" title="区块链技术与研究进展">区块链技术与研究进展</a></li><li><a href="/2023/06/18/%E7%A0%B4%E8%A7%A3010Editor/" rel="bookmark" title="破解010Editor">破解010Editor</a></li><li><a href="/2023/06/18/DSACTF%E9%80%86%E5%90%91%E4%B8%93%E9%A1%B9/" rel="bookmark" title="DSACTF逆向专项">DSACTF逆向专项</a></li><li><a href="/2023/07/03/Google-CTF-2023/" rel="bookmark" title="Google CTF 2023">Google CTF 2023</a></li><li><a href="/2023/07/03/UIUCTF2023/" rel="bookmark" title="UIUCTF2023">UIUCTF2023</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="sky"
      data-src="/images/avatar.png">
  <p class="name" itemprop="name">sky</p>
  <div class="description" itemprop="description">一只菜狗的博客</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">22</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">2</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tLzNjbHk=" title="https:&#x2F;&#x2F;github.com&#x2F;3cly"><i class="ic i-github"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

    
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

    
  <li class="item">
    <a href="/link/" rel="section"><i class="ic i-magic"></i>links</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/04/02/%E5%87%A0%E9%81%93RE%E9%A2%98/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/04/25/pixel-4a-root/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%9A%8F%E7%AC%94/" title="分类于 随笔">随笔</a>
</div>

    <span><a href="/2022/12/15/%E9%9A%8F%E7%AC%94/" title="以前的杂记">以前的杂记</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0/" title="分类于 学习">学习</a>
</div>

    <span><a href="/2023/06/18/%E7%A0%B4%E8%A7%A3010Editor/" title="破解010Editor">破解010Editor</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0/" title="分类于 学习">学习</a>
</div>

    <span><a href="/2023/03/19/JAVA%E5%AD%A6%E4%B9%A0/" title="JAVA学习">JAVA学习</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0/" title="分类于 学习">学习</a>
</div>

    <span><a href="/2023/04/25/pixel-4a-root/" title="pixel 4a root">pixel 4a root</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0/" title="分类于 学习">学习</a>
</div>

    <span><a href="/2023/02/04/hgame2023%20%E9%83%A8%E5%88%86%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/" title="hgame2023 部分做题记录">hgame2023 部分做题记录</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0/" title="分类于 学习">学习</a>
</div>

    <span><a href="/2023/03/19/Write-Virtual-Machine/" title="Write Virtual Machine">Write Virtual Machine</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Hexo/" title="分类于 Hexo">Hexo</a>
</div>

    <span><a href="/2022/12/15/%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B/" title="搭建过程">搭建过程</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0/" title="分类于 学习">学习</a>
</div>

    <span><a href="/2023/05/28/%E5%88%9D%E8%AF%86Frida/" title="初识Frida">初识Frida</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Hexo/" title="分类于 Hexo">Hexo</a>
</div>

    <span><a href="/2022/12/15/%E5%8D%9A%E5%AE%A2%E7%AE%80%E4%BB%8B/" title="博客简介">博客简介</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%9F%BA%E6%9C%ACROP%E5%AD%A6%E4%B9%A0/" title="分类于 基本ROP学习">基本ROP学习</a>
</div>

    <span><a href="/2022/12/15/%E5%9F%BA%E6%9C%ACROP%E5%AD%A6%E4%B9%A0/" title="基本ROP学习">基本ROP学习</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2022 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">sky @ 静かな港</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">85k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">1:18</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/04/16/Angr符号执行学习笔记/',
    favicon: {
      show: "（●´3｀●）やれやれだぜ",
      hide: "(´Д｀)大変だ！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
